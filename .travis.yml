language: java

jdk:
  - oraclejdk8

sudo: required

services:
  - docker

notifications:
    slack: nci-agency:TvRV22whtaRGflaCPPfv2G1v

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - client/node_modules

before_install:
  - echo "run.environment(\"DB_DRIVER\", \"sqlserver\")" > localSettings.gradle
  - echo "run.environment(\"ANET_SA_PASSWORD\", \"SA-P@ssw0rd\")" >> localSettings.gradle
  - echo "run.environment(\"ANET_DB_SERVER\", \"localhost\")"  >> localSettings.gradle
  - echo "run.environment(\"ANET_DB_NAME\", \"testAnet\")" >> localSettings.gradle
  - echo "run.environment(\"ANET_DB_USERNAME\", \"anetUser\")" >> localSettings.gradle
  - echo "run.environment(\"ANET_DB_PASSWORD\", \"Test-P@ssw0rd\")" >> localSettings.gradle
  - echo "run.environment(\"ANET_DB_PORT\", 1433)" >> localSettings.gradle
  - ./gradlew dockerCreateDB dockerStartDB

#By default travis runs gradle assemble in install. This is too early as we don't want to build yet
install:
  - ./gradlew npmInstall

script:
  - docker exec -ti -e "DB_NAME=testAnet" -e "DB_USER=anetUser" -e "DB_USER_PASSWORD=Test-P@ssw0rd" anet-mssql-server /opt/waitTillServiceStarted.sh
  - ./gradlew dbMigrate
  - docker exec -ti anet-mssql-server /opt/mssql-tools/bin/sqlcmd -S localhost -U anetUser -P 'Test-P@ssw0rd' -d testAnet -i /hostdata/insertBaseData.sql
  - ./gradlew check

after_script:
  - docker logs anet-mssql-server
